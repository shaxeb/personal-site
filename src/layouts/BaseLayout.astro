---
import "../styles/global.css";
import { Toaster } from "sonner";

const { title, description } = Astro.props;
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<meta
			name="description"
			content={description || "Personal website and blog of Shahzeb"}
		/>
		<title>{title || "My Blog"}</title>
		<style>
			/* animation for links */
			a {
				transition: color 0.3s ease;
			}

			/* fade-in for main content */
			main {
				animation: fadeIn 0.5s ease-in-out;
			}

			@keyframes fadeIn {
				from {
					opacity: 0;
				}
				to {
					opacity: 1;
				}
			}
		</style>
	</head>
	<body class="bg-neutral-50 text-neutral-800 font-sans">
		<Toaster position="bottom-center" richColors client:load />
		<div class="max-w-2xl mx-auto px-6 py-12">
			<main class="space-y-8">
				<slot />
				{/* Page content will be injected here */}
			</main>

			{/* Newsletter Section - Modified for ConvertKit */}
			<section class="mt-16 pt-8 border-t border-neutral-200">
				<h2 class="text-xl font-semibold mb-4">Newsletter</h2>
				<p class="mb-4 text-neutral-600">
					Get updates when I publish new content.
				</p>
				<form
					id="newsletter-form"
					class="flex flex-col sm:flex-row gap-2"
				>
					<input
						type="email"
						name="email"
						id="email"
						required
						placeholder="Your email address"
						class="flex-grow px-3 py-2 border border-neutral-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-300 sm:text-sm"
					/>
					<button
						type="submit"
						class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
					>
						Subscribe
					</button>
				</form>
			</section>

			{/* Footer Section */}
			<footer
				class="mt-12 pt-6 border-t border-neutral-200 text-center text-neutral-500 text-sm"
			>
				&copy; {new Date().getFullYear()} shah.build. All rights reserved.
			</footer>
		</div>

		<script>
			import { toast } from "sonner";

			document.addEventListener("DOMContentLoaded", () => {
				const form = document.getElementById(
					"newsletter-form",
				) as HTMLFormElement;
				if (!form) return;

				const submitButton = form.querySelector(
					'button[type="submit"]',
				) as HTMLButtonElement;

				form.addEventListener("submit", async (event) => {
					event.preventDefault();
					if (submitButton) submitButton.disabled = true;

					const submittingToastId = toast.loading("Submitting...");

					const emailInput = form.querySelector(
						"#email",
					) as HTMLInputElement;
					const email = emailInput?.value;

					try {
						if (!email) {
							throw new Error("Email is required.");
						}
						const response = await fetch("/api/subscribe", {
							method: "POST",
							headers: {
								"Content-Type": "application/json",
							},
							body: JSON.stringify({ email: email }),
						});

						const result = await response.json();

						if (response.ok) {
							toast.success(
								result.message ||
									"Success! You're on the list.",
								{ id: submittingToastId },
							);
							form.reset();
						} else {
							toast.error(
								result.message || "An error occurred.",
								{ id: submittingToastId },
							);
						}
					} catch (error) {
						console.error("Form submission error:", error);
						toast.error(
							error instanceof Error
								? error.message
								: "An unexpected error occurred. Please try again.",
							{ id: submittingToastId },
						);
					} finally {
						if (submitButton) submitButton.disabled = false;
					}
				});
			});
		</script>
	</body>
</html>
